rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // Hilfsfunktion, um zu prüfen, ob ein Benutzer authentifiziert ist
    function isAuthenticated() {
      // return request.auth != null;
      return true; // TEMPORÄR FÜR ENTWICKLUNG: Erlaube Zugriff ohne echte Authentifizierung

    }

    // Regeln für die 'dayStatusEntries' Collection
    // Dokument-ID-Format: personId-jahr-monat-tag (z.B. "1-2024-0-15")
    match /dayStatusEntries/{entryId} {
      // alow read: if isAuthenticated();
      allow read, write: if isAuthenticated(); // Vereinfacht für Entwicklung

      // Erstellen erlauben, wenn authentifiziert und Daten valide sind
      allow create: if isAuthenticated()
                    // Validierung der Datentypen und Werte
                    && request.resource.data.personId is string
                    && request.resource.data.year is number
                    && request.resource.data.month is number && request.resource.data.month >= 0 && request.resource.data.month <= 11
                    && request.resource.data.day is number && request.resource.data.day >= 1 && request.resource.data.day <= 31
                    && request.resource.data.status is string
                    && (request.resource.data.status == 'urlaub' || request.resource.data.status == 'durchfuehrung')
                    // Sicherstellen, dass die Dokument-ID mit den Daten übereinstimmt
                    && entryId == request.resource.data.personId + '-' +
                                  string(request.resource.data.year) + '-' +
                                  string(request.resource.data.month) + '-' +
                                  string(request.resource.data.day);
                    // ZUKÜNFTIG: Verknüpfung mit dem angemeldeten Benutzer, z.B.:
                    // && request.resource.data.userId == request.auth.uid; // Wenn jede Person einen eigenen Firebase-Account hat
                    // ODER wenn es eine Admin-Rolle gibt, die alles bearbeiten darf.

      // Aktualisieren erlauben, wenn authentifiziert und Daten valide sind
      // personId, year, month, day dürfen nicht geändert werden, da sie Teil der Dokument-ID sind
      allow update: if isAuthenticated()
                    && request.resource.data.personId == resource.data.personId
                    && request.resource.data.year == resource.data.year
                    && request.resource.data.month == resource.data.month
                    && request.resource.data.day == resource.data.day
                    && request.resource.data.status is string
                    && (request.resource.data.status == 'urlaub' || request.resource.data.status == 'durchfuehrung');
                    // ZUKÜNFTIG: Verknüpfung mit dem angemeldeten Benutzer (siehe 'create')

      // Löschen erlauben, wenn authentifiziert
      allow delete: if isAuthenticated();
                    // ZUKÜNFTIG: Verknüpfung mit dem angemeldeten Benutzer (siehe 'create')
    }

    // Regeln für die 'resturlaubData' Collection
    // Dokument-ID-Format: personId-forYear (z.B. "1-2024")
    match /resturlaubData/{resturlaubId} {
      // allow read: if isAuthenticated();
      allow read, write: if isAuthenticated(); // Vereinfacht für Entwicklung

      // Erstellen erlauben, wenn authentifiziert und Daten valide sind
      allow create: if isAuthenticated()
                    && request.resource.data.personId is string
                    && request.resource.data.forYear is number
                    && request.resource.data.tage is number && request.resource.data.tage >= 0
                    // Sicherstellen, dass die Dokument-ID mit den Daten übereinstimmt
                    && resturlaubId == request.resource.data.personId + '-' +
                                      string(request.resource.data.forYear);
                    // ZUKÜNFTIG: Stärkere Rechteprüfung, z.B. nur Admins dürfen Resturlaub anlegen/ändern.

      // Aktualisieren erlauben, wenn authentifiziert und Daten valide sind
      // personId und forYear dürfen nicht geändert werden
      allow update: if isAuthenticated()
                    && request.resource.data.personId == resource.data.personId
                    && request.resource.data.forYear == resource.data.forYear
                    && request.resource.data.tage is number && request.resource.data.tage >= 0;
                    // ZUKÜNFTIG: Stärkere Rechteprüfung (siehe 'create')

      // Löschen erlauben, wenn authentifiziert (obwohl in der App aktuell nicht genutzt)
      allow delete: if isAuthenticated();
                    // ZUKÜNFTIG: Stärkere Rechteprüfung (siehe 'create')
    }
  }
}
